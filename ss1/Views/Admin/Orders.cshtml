@model List<ss1.Models.PhotoSubmission>
@using ss1.Models

@{
    ViewData["Title"] = "Канбан-дошка";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var serviceNames = ViewBag.ServiceNames as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>@ViewData["Title"]</title>
    <link rel="icon" type="image/x-icon" href="~/images/icons/favicon.ico" />
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f5f7fa;
        }

            /* Головний контейнер flex */
            body > div {
                display: flex;
                height: 100vh;
                width: 100%;
            }

        .sidebar {
            width: 240px;
            background-color: #1e3a8a;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

            .sidebar h2 {
                font-size: 20px;
                margin-bottom: 30px;
            }

        .nav-link {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

            .nav-link:hover,
            .nav-link.active {
                background-color: #3b82f6;
            }

        .main {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

            .top-bar h1 {
                font-size: 24px;
            }

        .avatar {
            width: 40px;
            height: 40px;
            background-color: #ccc;
            border-radius: 50%;
        }

        .kanban-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .column {
            flex: 1;
            min-width: 300px;
            padding: 10px;
            background-color: #f4f4f4;
            border-radius: 8px;
            min-height: 400px;
        }

            .column h3 {
                text-align: center;
            }

        .card {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: move;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .card p {
                margin: 4px 0;
                font-size: 14px;
            }

        .drag-over {
            background-color: #d0e7ff;
        }
    </style>
</head>
<body>
    <div style="display: flex; height: 100vh;">
        <div class="sidebar">
            <h2>Адмін панель </h2>
            <a href="/Admin/Dashboard" class="nav-link">📊 Статистика</a>
            <a href="/Admin/Users" class="nav-link">👥 Користувачі</a>
            <a href="/Admin/ReviewPhotos" class="nav-link">👥 Замовлення</a>
            <a href="/Admin/Orders" class="nav-link">🛒 Канбандошка</a>
            <a href="/Admin/Archive" class="nav-link">📁 Архів</a>
            <a href="/Admin/Products" class="nav-link">📦 Продукти</a>
            <a href="/Admin/Messages" class="nav-link">💬 Повідомлення</a>
            <a href="/Admin/Settings" class="nav-link">⚙️ Налаштування</a>
            <a href="/" class="nav-link">⏻ Вийти</a>
        </div>

        <div class="main">
            <div class="top-bar">
                <h1>@ViewData["Title"]</h1>
                <div class="avatar"></div>
            </div>

            @* kanban-container *@

            @Html.AntiForgeryToken()

            <div class="kanban-container">
                @foreach (SubmissionStatus status in Enum.GetValues(typeof(SubmissionStatus)))
                {
                    <div class="column" data-status="@status" ondragover="onDragOver(event)" ondrop="onDrop(event)">
                        <h3>
                            @(status switch
                            {
                                SubmissionStatus.Pending => "Очікується",
                                SubmissionStatus.InProgress => "В процесі",
                                SubmissionStatus.Completed => "Завершено",
                                _ => status.ToString()
                            })
                        </h3>

                        @foreach (var submission in Model.Where(p => p.Status == status && !p.IsDelivered))
                        {
                            var serviceType = submission.ServiceType;
                            var serviceName = !string.IsNullOrEmpty(serviceType) && serviceNames.ContainsKey(serviceType)
                            ? serviceNames[serviceType]
                            : "Невідома послуга";

                            <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 8px;"
                                 class="card"
                                 draggable="true"
                                 ondragstart="onDragStart(event)"
                                 data-id="@submission.Id">
                                <h3>Фото на перевірку №@submission.OrderNumber</h3>
                                <p><strong>ID:</strong> @submission.GlobalOrderId</p>

                                <p><strong>Файл:</strong> @submission.FileName</p>

                                <p>
                                    <a asp-action="ViewPhoto" asp-route-id="@submission.Id"
                                       target="_blank"
                                       class="btn btn-sm"
                                       style="color: black; padding: 6px 12px; border-radius: 6px; text-decoration: none;">
                                        🔍 Переглянути фото
                                    </a>
                                </p>

                                @if (status == SubmissionStatus.InProgress || status == SubmissionStatus.Completed)
                                {
                                    <p>
                                        <a asp-action="DownloadPhoto" asp-route-id="@submission.Id"
                                           target="_blank"
                                           class="btn btn-sm btn-primary"
                                           style="color: black; padding: 6px 12px; border-radius: 6px; text-decoration: none;">
                                            📥 Завантажити фото
                                        </a>
                                    </p>
                                }

                                <p><strong>Послуга:</strong> @serviceName</p>
                                <p><strong>Коментар:</strong> @submission.Comment</p>
                                <p><strong>Ціна:</strong> @submission.Price грн</p>
                                <p><strong>Від:</strong> @submission.UserEmail</p>

                                @if (status == SubmissionStatus.Completed)
                                {
                                    <form asp-action="UploadAndSendProcessedPhoto" asp-controller="Admin" enctype="multipart/form-data" method="post" style="margin-top: 10px;">
                                        <input type="hidden" name="id" value="@submission.Id" />
                                        <input type="file" name="processedFile" accept="image/*" required />
                                        @Html.AntiForgeryToken()
                                        <button type="submit">📤 Завантажити та надіслати</button>
                                    </form>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            @* kanban-container *@

        </div>
    </div>

    <script>
        let draggedCardId = null;

        function onDragStart(e) {
            draggedCardId = e.target.dataset.id;
        }

        function onDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function onDrop(e) {
            e.preventDefault();
            const newStatus = e.currentTarget.dataset.status;
            e.currentTarget.classList.remove('drag-over');

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/Admin/UpdateStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    id: draggedCardId,
                    newStatus: newStatus
                })
            }).then(res => {
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Помилка при оновленні статусу");
                }
            });
        }
    </script>
</body>
</html>



